<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Custom Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Discord風 CSS (Updated) --- */
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --channel-textarea: #40444b;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --interactive-hover: #dcddde;
            --brand: #5865f2;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-normal); height: 100vh; overflow: hidden; display: flex; }

        /* ログインオーバーレイ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { background: var(--bg-secondary); padding: 40px; border-radius: 8px; width: 400px; box-shadow: 0 2px 10px 0 rgba(0,0,0,0.2); text-align: center; }
        .login-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: white; }
        .login-input { width: 100%; padding: 10px; margin-bottom: 15px; background: var(--bg-tertiary); border: 1px solid #202225; color: white; border-radius: 4px; height: 40px; }
        .login-btn { width: 100%; background: var(--brand); color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; height: 44px; }
        .login-btn:hover { background-color: #4752c4; }
        .login-note { font-size: 12px; color: var(--text-muted); margin-top: 10px; text-align: left; }

        /* 左サイドバー (サーバーリスト) */
        .server-list { width: 72px; background-color: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .server-icon { width: 48px; height: 48px; background-color: var(--bg-primary); border-radius: 50%; margin-bottom: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--text-normal); }
        .server-icon:hover, .server-icon.active { border-radius: 16px; background-color: var(--brand); color: white; }
        .separator { width: 32px; height: 2px; background-color: var(--bg-secondary); margin: 4px 0; }

        /* チャンネルリストエリア */
        .sidebar { width: 240px; background-color: var(--bg-secondary); display: flex; flex-direction: column; }
        .server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); justify-content: space-between; }
        
        .channel-list { flex: 1; padding: 8px; overflow-y: auto; }
        .category-header { display: flex; align-items: center; justify-content: space-between; padding-right: 8px; margin-bottom: 4px; margin-top: 16px; }
        .category { font-size: 12px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; padding-left: 8px; }
        .add-channel-btn { color: var(--text-muted); cursor: pointer; font-size: 14px; }
        .add-channel-btn:hover { color: var(--text-normal); }

        .channel { padding: 6px 8px; border-radius: 4px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; margin-bottom: 2px; }
        .channel:hover { background-color: rgba(79,84,92,0.16); color: var(--interactive-hover); }
        .channel.active { background-color: rgba(79,84,92,0.32); color: white; }
        .channel i { margin-right: 6px; font-size: 14px; color: #72767d; }
        .channel.active i { color: white; }

        /* ユーザーコントロール */
        .user-controls { background-color: #292b2f; padding: 8px; display: flex; align-items: center; }
        .avatar { width: 32px; height: 32px; background-color: var(--brand); border-radius: 50%; position: relative; margin-right: 8px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; font-weight: bold; }
        .status-dot { width: 10px; height: 10px; background-color: var(--success); border-radius: 50%; position: absolute; bottom: -2px; right: -2px; border: 2px solid #292b2f; }
        .user-info { flex: 1; overflow: hidden; }
        .username { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-id-display { font-size: 12px; color: var(--text-muted); }
        .control-btn { border: none; background: none; color: #b9bbbe; cursor: pointer; padding: 8px; border-radius: 4px; }
        .control-btn:hover { background-color: rgba(79,84,92,0.32); }
        .control-btn.active-red { color: var(--danger); }
        .control-btn.active-green { color: var(--success); }

        /* メインチャットエリア */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; box-shadow: 0 1px 0 rgba(4,4,5,0.2); }
        .chat-header-hash { color: var(--text-muted); margin-right: 8px; font-size: 20px; }
        .chat-header-title { font-weight: bold; }

        /* 接続パネル */
        .connection-panel { margin-left: auto; display: flex; gap: 8px; align-items: center; }
        .input-dark { background-color: var(--bg-tertiary); border: none; color: white; padding: 6px 12px; border-radius: 4px; font-size: 14px; }
        .btn-brand-sm { background-color: var(--brand); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-brand-sm:hover { background-color: #4752c4; }

        /* メッセージリスト */
        .messages-container { flex: 1; position: relative; overflow: hidden; }
        .messages-list { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 16px; display: none; flex-direction: column; gap: 16px; }
        .messages-list.active { display: flex; }
        
        .message { display: flex; margin-top: 4px; }
        .message:hover { background-color: rgba(4,4,5,0.02); }
        .message-content { margin-left: 10px; flex: 1; }
        .msg-header { display: flex; align-items: baseline; gap: 8px; }
        .msg-author { font-weight: bold; color: white; cursor: pointer; }
        .msg-timestamp { font-size: 12px; color: var(--text-muted); }
        .msg-text { color: var(--text-normal); white-space: pre-wrap; word-break: break-word; line-height: 1.4; }
        
        .system-msg { color: var(--text-muted); font-size: 13px; text-align: center; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .system-msg::before, .system-msg::after { content: ""; height: 1px; background: #4f545c; flex: 1; }

        /* 入力エリア */
        .input-area { padding: 0 16px 24px 16px; }
        .input-wrapper { background-color: var(--channel-textarea); border-radius: 8px; padding: 11px; display: flex; align-items: center; }
        .chat-input { background: transparent; border: none; color: var(--text-normal); width: 100%; resize: none; height: 22px; font-family: inherit; outline: none; }

        /* ビデオ/画面共有 */
        .video-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #000; display: none; border-bottom: 1px solid var(--bg-tertiary); }
        .video-grid.active { display: flex; min-height: 150px; }
        video { max-width: 250px; border-radius: 4px; background: #202225; }

        /* スクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; background-color: #2e3338; }
        ::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div class="login-title">P2P Chatへようこそ</div>
            <input type="text" id="login-display-name" class="login-input" placeholder="表示名 (ニックネーム)" maxlength="20">
            <input type="text" id="login-id" class="login-input" placeholder="希望するユーザーID (英数字)" maxlength="20">
            <button class="login-btn" onclick="initializePeer()">開始する</button>
            <div class="login-note">
                ※ユーザーIDは他の人と被ると接続できません。<br>
                ※サーバーレスのため、データはリロードすると消えます。
            </div>
        </div>
    </div>

    <div id="app-container" style="display: none; width: 100%; height: 100%;">
        <div class="server-list">
            <div class="server-icon active" title="Home"><i class="fas fa-ghost"></i></div>
            <div class="separator"></div>
        </div>

        <div class="sidebar">
            <div class="server-header">
                My P2P Server
            </div>
            
            <div class="channel-list" id="channel-list">
                <div class="category-header">
                    <div class="category">Text Channels</div>
                    <div class="add-channel-btn" onclick="createChannelUI()" title="スレを作成"><i class="fas fa-plus"></i></div>
                </div>
                </div>

            <div class="user-controls">
                <div class="avatar" id="my-avatar">U</div>
                <div class="user-info">
                    <div class="username" id="display-name-label">User</div>
                    <div class="user-id-display" id="my-id-label">#0000</div>
                </div>
                <button class="control-btn" id="btn-mic" onclick="toggleMic()" title="マイクON/OFF"><i class="fas fa-microphone"></i></button>
                <button class="control-btn" id="btn-screen" onclick="toggleScreen()" title="画面共有"><i class="fas fa-desktop"></i></button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <span class="chat-header-hash"><i class="fas fa-hashtag"></i></span>
                <span class="chat-header-title" id="current-channel-title">general</span>
                
                <div class="connection-panel">
                    <input type="text" id="target-id" class="input-dark" placeholder="相手のIDを入力" style="width: 150px;">
                    <button class="btn-brand-sm" onclick="connectToPeer()">接続</button>
                    <button class="control-btn" onclick="copyId()" title="自分のIDをコピー"><i class="fas fa-copy"></i></button>
                </div>
            </div>

            <div class="video-grid" id="video-grid"></div>

            <div class="messages-container" id="messages-container">
                </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <input type="text" class="chat-input" id="msg-input" placeholder="#general へメッセージを送信" onkeypress="handleInput(event)">
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let peer = null;
        let myPeerId = "";
        let myDisplayName = "";
        let connections = []; // DataConnections
        let mediaCalls = [];  // MediaConnections
        
        let channels = ['general']; // チャンネルリスト
        let currentChannel = 'general';
        
        // Media State
        let localStream = null;
        let screenStream = null;
        let isMicOn = true;
        let isScreenSharing = false;

        // --- 初期化 & ログイン ---
        function initializePeer() {
            const nameInput = document.getElementById('login-display-name').value.trim();
            const idInput = document.getElementById('login-id').value.trim();

            if (!nameInput || !idInput) {
                alert("表示名とIDを入力してください");
                return;
            }

            // IDのバリデーション (簡易)
            if (!/^[a-zA-Z0-9_-]+$/.test(idInput)) {
                alert("IDは半角英数字、ハイフン、アンダースコアのみ使用できます");
                return;
            }

            myDisplayName = nameInput;
            document.querySelector('.login-btn').innerText = "接続中...";

            // PeerJS接続
            peer = new Peer(idInput, { debug: 1 });

            peer.on('open', (id) => {
                myPeerId = id;
                startApp();
            });

            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    alert("そのIDは既に使用されています。別のIDを指定してください。");
                    document.querySelector('.login-btn').innerText = "開始する";
                } else {
                    alert("接続エラー: " + err.type);
                    document.querySelector('.login-btn').innerText = "開始する";
                }
            });
        }

        function startApp() {
            // UI切り替え
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex'; // blockではなくflex

            // ユーザー情報表示
            document.getElementById('display-name-label').textContent = myDisplayName;
            document.getElementById('my-id-label').textContent = myPeerId;
            document.getElementById('my-avatar').textContent = myDisplayName.charAt(0).toUpperCase();

            // 初期チャンネルセットアップ
            setupChannel('general');

            // マイク準備
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    updateMicIcon();
                })
                .catch(err => {
                    console.log('Mic denied', err);
                    isMicOn = false;
                    updateMicIcon();
                });

            // イベントリスナ設定
            setupPeerEvents();
        }

        function setupPeerEvents() {
            peer.on('connection', (conn) => {
                handleConnection(conn);
                // 接続相手に自分の表示名と既存チャンネル情報を送る（簡易同期）
                conn.on('open', () => {
                    conn.send({ type: 'info', name: myDisplayName });
                    channels.forEach(ch => {
                        if(ch !== 'general') conn.send({ type: 'new_channel', channel: ch });
                    });
                });
            });

            peer.on('call', (call) => {
                call.answer(localStream);
                handleCall(call);
            });
        }

        function connectToPeer() {
            const targetId = document.getElementById('target-id').value.trim();
            if (!targetId || targetId === myPeerId) return;

            // 既存チェック
            if (connections.find(c => c.peer === targetId)) {
                alert("既に接続済みです");
                return;
            }

            const conn = peer.connect(targetId);
            handleConnection(conn);

            conn.on('open', () => {
                // 名前送信
                conn.send({ type: 'info', name: myDisplayName });
                // チャンネル情報送信
                channels.forEach(ch => {
                    if(ch !== 'general') conn.send({ type: 'new_channel', channel: ch });
                });
                // 通話発信
                if (localStream) {
                    const call = peer.call(targetId, localStream);
                    handleCall(call);
                }
            });
        }

        // --- データ通信ハンドリング ---
        function handleConnection(conn) {
            connections.push(conn);
            
            conn.on('data', (data) => {
                switch(data.type) {
                    case 'chat':
                        addMessageToUI(data.channel, data.name, data.msg, false);
                        // もし未読チャンネルなら通知バッジなどの処理もここで可能
                        break;
                    case 'info':
                        addSystemMessage('general', `${data.name} (${conn.peer}) が参加しました`);
                        break;
                    case 'new_channel':
                        addChannel(data.channel, false); // false = 自分発信ではない
                        break;
                }
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                addSystemMessage('general', `ユーザー ${conn.peer} が切断しました`);
            });

            conn.on('error', (err) => {
                console.error("Conn Error", err);
            });
        }

        // --- チャンネル管理 ---
        
        function setupChannel(channelName) {
            // UI生成
            const list = document.getElementById('channel-list');
            const div = document.createElement('div');
            div.className = `channel ${channelName === currentChannel ? 'active' : ''}`;
            div.id = `ch-btn-${channelName}`;
            div.innerHTML = `<i class="fas fa-hashtag"></i> ${channelName}`;
            div.onclick = () => switchChannel(channelName);
            list.appendChild(div);

            // メッセージコンテナ生成
            const container = document.getElementById('messages-container');
            const msgList = document.createElement('div');
            msgList.className = `messages-list ${channelName === currentChannel ? 'active' : ''}`;
            msgList.id = `msgs-${channelName}`;
            
            // Welcomeメッセージ
            msgList.innerHTML = `<div class="system-msg">#${channelName} の始まりです</div>`;
            container.appendChild(msgList);
        }

        function createChannelUI() {
            const name = prompt("新しいスレ（チャンネル）の名前を入力してください:");
            if (!name) return;
            const safeName = name.replace(/[^a-zA-Z0-9_-]/g, "").toLowerCase();
            if (!safeName) { alert("英数字で入力してください"); return; }
            if (channels.includes(safeName)) { alert("既に存在します"); return; }

            addChannel(safeName, true);
        }

        function addChannel(name, broadcast) {
            if (channels.includes(name)) return;
            channels.push(name);
            setupChannel(name);

            if (broadcast) {
                // 全員に通知
                broadcastData({ type: 'new_channel', channel: name });
                // 自分で作成した場合は即座に切り替え
                switchChannel(name);
            } else {
                addSystemMessage('general', `新しいチャンネル #${name} が作成されました`);
            }
        }

        function switchChannel(name) {
            // 前のチャンネルを非アクティブ化
            document.getElementById(`ch-btn-${currentChannel}`).classList.remove('active');
            document.getElementById(`msgs-${currentChannel}`).classList.remove('active');

            currentChannel = name;

            // 新しいチャンネルをアクティブ化
            document.getElementById(`ch-btn-${currentChannel}`).classList.add('active');
            document.getElementById(`msgs-${currentChannel}`).classList.add('active');
            
            // ヘッダー更新
            document.getElementById('current-channel-title').textContent = name;
            document.getElementById('msg-input').placeholder = `#${name} へメッセージを送信`;
            document.getElementById('msg-input').focus();
        }

        // --- チャット機能 ---
        function handleInput(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('msg-input');
                const msg = input.value;
                if (!msg.trim()) return;

                // 自分のUIに追加
                addMessageToUI(currentChannel, myDisplayName, msg, true);
                
                // 送信
                broadcastData({
                    type: 'chat',
                    channel: currentChannel,
                    name: myDisplayName,
                    msg: msg
                });

                input.value = '';
            }
        }

        function broadcastData(data) {
            connections.forEach(conn => {
                if (conn.open) conn.send(data);
            });
        }

        function addMessageToUI(channel, name, text, isMe) {
            // チャンネルが存在しない場合は作成（受信側用）
            if (!channels.includes(channel)) {
                addChannel(channel, false);
            }

            const container = document.getElementById(`msgs-${channel}`);
            if (!container) return;

            const date = new Date();
            const timeStr = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = `
                <div class="avatar" style="background-color: ${isMe ? '#5865f2' : '#ed4245'}">${name.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="msg-header">
                        <span class="msg-author">${escapeHtml(name)}</span>
                        <span class="msg-timestamp">Today at ${timeStr}</span>
                    </div>
                    <div class="msg-text">${escapeHtml(text)}</div>
                </div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(channel, text) {
            const container = document.getElementById(`msgs-${channel}`);
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'system-msg';
            div.textContent = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- メディア(通話/画面共有) ---
        function handleCall(call) {
            mediaCalls.push(call);
            call.on('stream', (remoteStream) => {
                addVideo(remoteStream, call.peer);
            });
            call.on('close', () => {
                removeVideo(call.peer);
                mediaCalls = mediaCalls.filter(c => c !== call);
            });
        }

        function toggleMic() {
            if (!localStream) return;
            isMicOn = !isMicOn;
            localStream.getAudioTracks()[0].enabled = isMicOn;
            updateMicIcon();
        }

        function updateMicIcon() {
            const btn = document.getElementById('btn-mic');
            btn.innerHTML = isMicOn ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            if (isMicOn) btn.classList.remove('active-red');
            else btn.classList.add('active-red');
        }

        async function toggleScreen() {
            if (isScreenSharing) {
                // Stop Sharing
                if (screenStream) {
                    screenStream.getTracks().forEach(track => track.stop());
                }
                isScreenSharing = false;
                document.getElementById('btn-screen').classList.remove('active-green');
                document.getElementById('video-grid').classList.remove('active');
                removeVideo('me-screen');
            } else {
                // Start Sharing
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    isScreenSharing = true;
                    document.getElementById('btn-screen').classList.add('active-green');
                    document.getElementById('video-grid').classList.add('active');

                    // 自分用プレビュー
                    addVideo(screenStream, 'me-screen');

                    // 全員に発信
                    connections.forEach(conn => {
                        const call = peer.call(conn.peer, screenStream);
                    });

                    screenStream.getVideoTracks()[0].onended = () => toggleScreen();

                } catch (err) {
                    console.error("Screen share error", err);
                }
            }
        }

        function addVideo(stream, id) {
            const grid = document.getElementById('video-grid');
            grid.classList.add('active');
            if (document.getElementById(`vid-${id}`)) return;

            const v = document.createElement('video');
            v.srcObject = stream;
            v.id = `vid-${id}`;
            v.autoplay = true;
            v.playsInline = true;
            if (id === 'me-screen') v.muted = true;
            grid.appendChild(v);
        }

        function removeVideo(id) {
            const v = document.getElementById(`vid-${id}`);
            if (v) v.remove();
            if (document.getElementById('video-grid').children.length === 0) {
                document.getElementById('video-grid').classList.remove('active');
            }
        }

        // --- Utils ---
        function copyId() {
            navigator.clipboard.writeText(myPeerId).then(() => alert("IDをコピーしました: " + myPeerId));
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
