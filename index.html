<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Discord-like Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- Discord風 UI CSS --- */
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --channel-textarea: #40444b;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --interactive-normal: #b9bbbe;
            --interactive-hover: #dcddde;
            --brand: #5865f2;
            --danger: #ed4245;
            --success: #3ba55c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: var(--bg-primary); color: var(--text-normal); height: 100vh; overflow: hidden; display: flex; }

        /* 左サイドバー (サーバーリスト) */
        .server-list { width: 72px; background-color: var(--bg-tertiary); display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .server-icon { width: 48px; height: 48px; background-color: var(--bg-primary); border-radius: 50%; margin-bottom: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-normal); }
        .server-icon:hover { border-radius: 16px; background-color: var(--brand); color: white; }
        .server-icon.active { border-radius: 16px; background-color: var(--brand); }
        .separator { width: 32px; height: 2px; background-color: var(--bg-secondary); margin: 4px 0; }

        /* チャンネルリストエリア */
        .sidebar { width: 240px; background-color: var(--bg-secondary); display: flex; flex-direction: column; }
        .server-header { height: 48px; padding: 0 16px; display: flex; align-items: center; font-weight: bold; box-shadow: 0 1px 0 rgba(4,4,5,0.2); cursor: pointer; transition: 0.2s; }
        .server-header:hover { background-color: rgba(79,84,92,0.16); }
        
        .channel-list { flex: 1; padding: 8px; overflow-y: auto; }
        .category { font-size: 12px; font-weight: bold; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px; padding-left: 8px; }
        .channel { padding: 6px 8px; border-radius: 4px; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; margin-bottom: 2px; }
        .channel:hover { background-color: rgba(79,84,92,0.16); color: var(--interactive-hover); }
        .channel.active { background-color: rgba(79,84,92,0.32); color: white; }
        .channel i { margin-right: 6px; font-size: 14px; }

        /* ユーザーコントロール (下部) */
        .user-controls { background-color: #292b2f; padding: 8px; display: flex; align-items: center; }
        .avatar { width: 32px; height: 32px; background-color: var(--brand); border-radius: 50%; position: relative; margin-right: 8px; }
        .status-dot { width: 10px; height: 10px; background-color: var(--success); border-radius: 50%; position: absolute; bottom: -2px; right: -2px; border: 2px solid #292b2f; }
        .user-info { flex: 1; overflow: hidden; }
        .username { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-id { font-size: 12px; color: var(--text-muted); }
        .control-btn { border: none; background: none; color: var(--interactive-normal); cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
        .control-btn:hover { background-color: rgba(79,84,92,0.32); }
        .control-btn.active-red { color: var(--danger); }
        .control-btn.active-green { color: var(--success); }

        /* メインチャットエリア */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); min-width: 0; }
        .chat-header { height: 48px; padding: 0 16px; display: flex; align-items: center; box-shadow: 0 1px 0 rgba(4,4,5,0.2); }
        .chat-header-hash { color: var(--text-muted); margin-right: 8px; font-size: 20px; }
        .chat-header-title { font-weight: bold; }

        /* 接続パネル */
        .connection-panel { padding: 10px; background-color: #2f3136; margin: 10px; border-radius: 8px; display: flex; gap: 8px; align-items: center; }
        .input-dark { background-color: var(--bg-tertiary); border: none; color: white; padding: 8px; border-radius: 4px; flex: 1; }
        .btn-brand { background-color: var(--brand); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-brand:hover { background-color: #4752c4; }

        /* メッセージリスト */
        .messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
        .message { display: flex; margin-top: 4px; }
        .message-content { margin-left: 10px; }
        .msg-header { display: flex; align-items: baseline; gap: 8px; }
        .msg-author { font-weight: bold; color: white; cursor: pointer; }
        .msg-author:hover { text-decoration: underline; }
        .msg-timestamp { font-size: 12px; color: var(--text-muted); }
        .msg-text { color: var(--text-normal); white-space: pre-wrap; word-break: break-word; }
        
        /* システムメッセージ */
        .system-msg { color: var(--text-muted); font-size: 13px; text-align: center; margin: 10px 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .system-msg::before, .system-msg::after { content: ""; height: 1px; background: #4f545c; flex: 1; }

        /* 入力エリア */
        .input-area { padding: 0 16px 24px 16px; }
        .input-wrapper { background-color: var(--channel-textarea); border-radius: 8px; padding: 10px; display: flex; align-items: center; }
        .chat-input { background: transparent; border: none; color: var(--text-normal); width: 100%; resize: none; height: 24px; font-family: inherit; outline: none; }

        /* ビデオ/画面共有エリア */
        .video-grid { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: #000; display: none; }
        .video-grid.active { display: flex; min-height: 200px; }
        video { max-width: 300px; border-radius: 8px; background: #202225; border: 2px solid var(--brand); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; background-color: #2e3338; }
        ::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="server-list">
        <div class="server-icon active"><i class="fab fa-discord"></i></div>
        <div class="separator"></div>
        <div class="server-icon"><i class="fas fa-plus"></i></div>
    </div>

    <div class="sidebar">
        <div class="server-header">My Private Server</div>
        
        <div class="channel-list">
            <div class="category">Text Channels</div>
            <div class="channel active"><i class="fas fa-hashtag"></i> general</div>
            <div class="channel"><i class="fas fa-hashtag"></i> off-topic</div>
            
            <div class="category" style="margin-top: 16px;">Voice Channels</div>
            <div class="channel"><i class="fas fa-volume-up"></i> General Voice</div>
        </div>

        <div class="user-controls">
            <div class="avatar">
                <div class="status-dot"></div>
            </div>
            <div class="user-info">
                <div class="username" id="my-id-display">Connecting...</div>
                <div class="user-id">#Online</div>
            </div>
            <button class="control-btn" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="control-btn" id="btn-screen" onclick="toggleScreen()"><i class="fas fa-desktop"></i></button>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <span class="chat-header-hash">#</span>
            <span class="chat-header-title">general</span>
            
            <div class="connection-panel" style="margin-left: auto; padding: 4px; background: none;">
                <input type="text" id="target-id" class="input-dark" placeholder="接続先IDを入力" style="width: 200px;">
                <button class="btn-brand" onclick="connectToPeer()">接続</button>
                <button class="control-btn" onclick="copyMyId()" title="自分のIDをコピー"><i class="fas fa-copy"></i></button>
            </div>
        </div>

        <div class="video-grid" id="video-grid">
            </div>

        <div class="messages" id="messages">
            <div class="system-msg">P2Pチャットへようこそ。まずは接続を確立してください。</div>
        </div>

        <div class="input-area">
            <div class="input-wrapper">
                <input type="text" class="chat-input" id="msg-input" placeholder="#general へメッセージを送信" onkeypress="handleInput(event)">
            </div>
        </div>
    </div>

    <script>
        // --- 設定とステータス ---
        let peer = null;
        let myId = "";
        let connections = []; // テキスト接続リスト
        let mediaCalls = [];  // メディア通話リスト
        let localStream = null;
        let screenStream = null;
        let isMicOn = true;
        let isScreenSharing = false;

        // --- PeerJS 初期化 ---
        // 無料のPeerJS Cloud Serverを利用
        peer = new Peer({
            debug: 2
        });

        peer.on('open', (id) => {
            myId = id;
            document.getElementById('my-id-display').textContent = id;
            addSystemMessage("あなたのID: " + id);
            
            // マイクストリームの取得（初期化）
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(stream => {
                    localStream = stream;
                    updateMicIcon();
                })
                .catch(err => {
                    console.error('マイクの取得に失敗:', err);
                    addSystemMessage("エラー: マイクへのアクセスが拒否されました");
                    isMicOn = false;
                    updateMicIcon();
                });
        });

        // --- 着信・接続ハンドラ ---
        
        // テキスト接続受信
        peer.on('connection', (conn) => {
            setupConnection(conn);
            addSystemMessage(`ユーザー ${conn.peer} が接続しました`);
            // 相手にこちらからも通話発信（双方向通話のため）
            if(localStream) callPeer(conn.peer);
        });

        // 通話着信受信
        peer.on('call', (call) => {
            // 自分のストリームを返して応答
            call.answer(localStream);
            setupCall(call);
        });

        // エラーハンドリング
        peer.on('error', (err) => {
            addSystemMessage(`エラー: ${err.type}`);
            console.error(err);
        });

        // --- 接続ロジック ---

        function connectToPeer() {
            const targetId = document.getElementById('target-id').value.trim();
            if (!targetId || targetId === myId) return;

            addSystemMessage(`接続試行中: ${targetId}...`);
            
            // 1. データ接続 (チャット用)
            const conn = peer.connect(targetId);
            setupConnection(conn);

            // 2. メディア接続 (通話用)
            if (localStream) {
                callPeer(targetId);
            }
        }

        function callPeer(peerId) {
            const call = peer.call(peerId, localStream);
            setupCall(call);
        }

        // --- 接続セットアップ詳細 ---

        function setupConnection(conn) {
            connections.push(conn);
            
            conn.on('open', () => {
                conn.send({ type: 'system', msg: 'Connected via PeerJS' });
            });

            conn.on('data', (data) => {
                if (data.type === 'chat') {
                    addMessage(data.user, data.msg, false);
                } else if (data.type === 'system') {
                    console.log("System:", data.msg);
                }
            });

            conn.on('close', () => {
                addSystemMessage(`${conn.peer} が切断しました`);
                connections = connections.filter(c => c !== conn);
            });
        }

        function setupCall(call) {
            mediaCalls.push(call);
            
            call.on('stream', (remoteStream) => {
                // 画面共有またはビデオ通話の表示
                // ※PeerJSの単一ストリーム制限のため、画面共有時は音声ストリームをどう扱うか課題があるが、
                // 簡易実装として新しいVideo要素を追加する
                addVideo(remoteStream, call.peer);
            });

            call.on('close', () => {
                removeVideo(call.peer);
                mediaCalls = mediaCalls.filter(c => c !== call);
            });
        }

        // --- 機能コントロール ---

        function toggleMic() {
            if (!localStream) return;
            isMicOn = !isMicOn;
            localStream.getAudioTracks()[0].enabled = isMicOn;
            updateMicIcon();
        }

        function updateMicIcon() {
            const btn = document.getElementById('btn-mic');
            if (isMicOn) {
                btn.innerHTML = '<i class="fas fa-microphone"></i>';
                btn.classList.remove('active-red');
            } else {
                btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                btn.classList.add('active-red');
            }
        }

        async function toggleScreen() {
            if (isScreenSharing) {
                // 画面共有停止
                stopScreenShare();
            } else {
                // 画面共有開始
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                    isScreenSharing = true;
                    document.getElementById('btn-screen').classList.add('active-green');
                    document.getElementById('video-grid').classList.add('active');

                    // 自分用のプレビュー
                    addVideo(screenStream, 'Me (Screen)');

                    // 接続中の全ピアに画面共有ストリームを発信
                    // 注: 既存の通話とは別に、新しいCallとして画面共有を送る
                    connections.forEach(conn => {
                        const call = peer.call(conn.peer, screenStream);
                    });

                    // 共有停止イベント
                    screenStream.getVideoTracks()[0].onended = () => {
                        stopScreenShare();
                    };

                } catch (err) {
                    console.error("画面共有キャンセルまたはエラー", err);
                }
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            isScreenSharing = false;
            document.getElementById('btn-screen').classList.remove('active-green');
            removeVideo('Me (Screen)');
        }

        // --- UI操作系 ---

        function handleInput(e) {
            if (e.key === 'Enter') {
                const input = document.getElementById('msg-input');
                const msg = input.value;
                if (!msg.trim()) return;

                // 自分の画面に表示
                addMessage("Me", msg, true);

                // 全員に送信
                connections.forEach(conn => {
                    if (conn.open) {
                        conn.send({ type: 'chat', user: 'User ' + myId.substring(0,4), msg: msg });
                    }
                });

                input.value = '';
            }
        }

        function addMessage(user, text, isMe) {
            const container = document.getElementById('messages');
            const date = new Date();
            const timeStr = `${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
            
            const msgHTML = `
                <div class="message">
                    <div class="avatar" style="background-color: ${isMe ? '#5865f2' : '#ed4245'}; min-width: 32px;"></div>
                    <div class="message-content">
                        <div class="msg-header">
                            <span class="msg-author">${user}</span>
                            <span class="msg-timestamp">今日 ${timeStr}</span>
                        </div>
                        <div class="msg-text">${escapeHtml(text)}</div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', msgHTML);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('messages');
            container.insertAdjacentHTML('beforeend', `<div class="system-msg">${text}</div>`);
            container.scrollTop = container.scrollHeight;
        }

        function addVideo(stream, peerId) {
            const grid = document.getElementById('video-grid');
            grid.classList.add('active');
            
            // 既に存在する場合は追加しない (簡易重複チェック)
            if (document.getElementById(`video-${peerId}`)) return;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.id = `video-${peerId}`;
            video.autoplay = true;
            video.playsInline = true;
            if (peerId === 'Me (Screen)') video.muted = true; // 自分の共有はミュート

            grid.appendChild(video);
        }

        function removeVideo(peerId) {
            const video = document.getElementById(`video-${peerId}`);
            if (video) video.remove();
            
            const grid = document.getElementById('video-grid');
            if (grid.children.length === 0) {
                grid.classList.remove('active');
            }
        }

        function copyMyId() {
            navigator.clipboard.writeText(myId).then(() => {
                alert("IDをコピーしました！");
            });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
